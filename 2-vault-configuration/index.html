
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../1-vault-install/">
      
      
        <link rel="next" href="../3-application/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.6">
    
    
      
        <title>Vault Configuration - Vault Quickstart</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.558e4712.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#vault-configuration" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Vault Quickstart" class="md-header__button md-logo" aria-label="Vault Quickstart" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Vault Quickstart
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Vault Configuration
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/eformat/vault-quickstart" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    eformat/vault-quickstart
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Vault Quickstart" class="md-nav__button md-logo" aria-label="Vault Quickstart" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Vault Quickstart
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/eformat/vault-quickstart" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    eformat/vault-quickstart
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Vault Zero to Hero
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../1-vault-install/" class="md-nav__link">
        Vault Install
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Vault Configuration
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Vault Configuration
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#namespace-and-mount-structuring-guide" class="md-nav__link">
    Namespace and Mount Structuring Guide
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#login-and-check-vault" class="md-nav__link">
    Login and check vault
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#team-based-access" class="md-nav__link">
    Team based access
  </a>
  
    <nav class="md-nav" aria-label="Team based access">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ldap" class="md-nav__link">
    LDAP
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#team-setup" class="md-nav__link">
    Team Setup
  </a>
  
    <nav class="md-nav" aria-label="Team Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#admin" class="md-nav__link">
    Admin
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#non-admin" class="md-nav__link">
    Non-Admin
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../3-application/" class="md-nav__link">
        Application
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../4-external-secrets-operator/" class="md-nav__link">
        External Secrets Operator
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../5-vault-configuration-operator/" class="md-nav__link">
        Vault Config Operator
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#namespace-and-mount-structuring-guide" class="md-nav__link">
    Namespace and Mount Structuring Guide
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#login-and-check-vault" class="md-nav__link">
    Login and check vault
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#team-based-access" class="md-nav__link">
    Team based access
  </a>
  
    <nav class="md-nav" aria-label="Team based access">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ldap" class="md-nav__link">
    LDAP
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#team-setup" class="md-nav__link">
    Team Setup
  </a>
  
    <nav class="md-nav" aria-label="Team Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#admin" class="md-nav__link">
    Admin
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#non-admin" class="md-nav__link">
    Non-Admin
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  



<h1 id="vault-configuration">Vault Configuration</h1>
<h2 id="namespace-and-mount-structuring-guide">Namespace and Mount Structuring Guide</h2>
<p class="tip">
⛷️ <b>TIP</b> ⛷️ - Skip the background reading if you want, but at some point you will need it !
</p>

<p>For this demo, there are a few <a href="https://learn.hashicorp.com/tutorials/vault/namespace-structure?in=vault/recommended-patterns">recommended patterns</a> and background reading on <a href="https://learn.hashicorp.com/tutorials/vault/policy-templating">ACL Policy templating</a> that should be considered a MUST read. In particular watch the <a href="https://www.youtube.com/watch?v=zDnIqSB4tyA&amp;t=1532s">Youtube Video</a>. Also checkout the <a href="../#references">References</a> links.</p>
<p>We will:</p>
<ul>
<li>setup vault self-service where team users can manage their own key values on a per team/application basis</li>
<li>leverage Vault identities and vault ACL templates for ensuring that apps can only read their own secrets</li>
<li>we do not use vault namespaces (they are an enterprise feature)</li>
<li>deploy an app and connect it to vault using an app k8s service-account</li>
<li>app k8s service-account can read, list secrets for that app only using ACL's</li>
<li>users in the team group have full access to their team secrets</li>
<li>admins must configure<ul>
<li>project, vault policy</li>
</ul>
</li>
<li>team users can configure<ul>
<li>app secrets, app service accounts, vault config for these</li>
</ul>
</li>
</ul>
<p>Everything in vault is path based.  The Paths we setup in vault are as follows.</p>
<pre><code class="language-bash">== Access ==
ldap/                                   &lt;-- ldap users in $TEAM_GROUP
token/                                  &lt;-- default, token
$BASE_DOMAIN-$PROJECT_NAME/$APP_NAME    &lt;-- kubernetes roles by cluster-project/app

== Groups ==
$TEAM_GROUP/                            &lt;-- ldap entity ids (users) for $TEAM_GROUP

== Secrets ==
kv/                                     &lt;-- kv version 2
kv/$TEAM_GROUP                          &lt;-- team group secrets
kv/$TEAM_GROUP/$PROJECT_NAME            &lt;-- project secrets
kv/$TEAM_GROUP/$PROJECT_NAME/$APP_NAME  &lt;-- app secrets kvv2

== Policies ==
$TEAM_GROUP_$APP_NAME/              &lt;-- users in $TEAM_GROUP CRUDL on kv/TEAM_GROUP
                                    &lt;-- k8s app sa auth/$BASE_DOMAIN-$PROJECT_NAME CRUDL

$BASE_DOMAIN-$PROJECT_NAME-kv-read  &lt;-- k8s app sa RL on kv/$TEAM_GROUP/$PROJECT_NAME/$APP_NAME

Notes: CRUDL = create, read, update, delete, list
</code></pre>
<h2 id="login-and-check-vault">Login and check vault</h2>
<p>Login to vault using the environment vars and token.</p>
<pre><code class="language-bash">vault login token=${ROOT_TOKEN}
</code></pre>
<p>If all is OK, you should see.</p>
<pre>
Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run "vault login"
again. Future Vault requests will automatically use this token.

Key                  Value
---                  -----
token                this-is-not-my-token
token_accessor       this-is-not-my-token-accessor
token_duration       ∞
token_renewable      false
token_policies       ["root"]
identity_policies    []
policies             ["root"]
</pre>

<p>We can check vault quorum is OK.</p>
<pre><code class="language-bash">vault operator raft list-peers
</code></pre>
<pre>
Node       Address                        State       Voter
----       -------                        -----       -----
vault-0    vault-0.vault-internal:8201    leader      true
vault-1    vault-1.vault-internal:8201    follower    true
vault-2    vault-2.vault-internal:8201    follower    true
</pre>

<p>If you browse to the Web UI you should be able to login using your token as well.</p>
<p><img alt="images/vault-login.png" src="../images/vault-login.png" /></p>
<h2 id="team-based-access">Team based access</h2>
<p>There are <a href="https://www.vaultproject.io/api-docs/auth/userpass">many</a> authentication methods supported by vault.</p>
<p>We use the <a href="https://github.com/redhat-cop/helm-charts/tree/master/charts/ipa">FreeIPA</a> helm chart in our OpenShift cluster to <a href="https://docs.openshift.com/container-platform/4.10/authentication/identity_providers/configuring-ldap-identity-provider.html">provision users</a>.</p>
<p>We will leave this as an exercise for the user to configure in your own cluster and I will leave this <a href="https://github.com/redhat-cop/agnosticd/blob/development/ansible/roles_ocp_workloads/ocp4_workload_tl500/tasks/workload.yml">automation breadcrumb trail</a> and helm chart hint to get you going:</p>
<pre><code class="language-bash">helm upgrade --install ipa redhat-cop/ipa --namespace=ipa \
  --create-namespace --set app_domain={{ apps_domain }} \
  --set admin_password={{ ldap_admin_password | quote }} \
  --set ocp_auth.enabled=true \
  --set ocp_auth.bind_password={{ ldap_admin_password | quote }} \
  --set ocp_auth.bind_dn={{ bind_dn | quote }} --timeout=45m
</code></pre>
<h3 id="ldap">LDAP</h3>
<p>We can easily configure vault to authenticate with LDAP. Export our <code>binddn</code> user password.</p>
<pre><code class="language-bash">export LDAP_BIND_PASSWORD=this-is-not-my-password
</code></pre>
<p>Change <code>dn</code>'s to suit your ldap configuration, enable auth login for vault.</p>
<pre><code class="language-bash">vault auth enable ldap
</code></pre>
<pre><code class="language-bash">vault write auth/ldap/config \
  url=&quot;ldap://ipa.ipa.svc.cluster.local:389&quot; \
  binddn=&quot;uid=ldap_admin,cn=users,cn=accounts,dc=redhatlabs,dc=com&quot; \
  bindpass=&quot;$LDAP_BIND_PASSWORD&quot; \
  userdn=&quot;cn=users,cn=accounts,dc=redhatlabs,dc=com&quot; \
  userattr=&quot;uid&quot; \
  groupdn=&quot;cn=student,cn=groups,cn=accounts,dc=redhatlabs,dc=com&quot; \
  groupattr=&quot;cn&quot;
</code></pre>
<p>If you login to vault from the Web UI you should see this Access &gt; Auth Methods &gt; <code>ldap</code> auth method.</p>
<p><img alt="images/auth-ldap-vault.png" src="../images/auth-ldap-vault.png" /></p>
<p>We can now try ldap using a regular user (<code>mike</code>). Our user <code>mike</code> is part of the <code>student</code> group in LDAP.</p>
<pre><code class="language-bash">vault login -method=ldap username=mike
</code></pre>
<p>If all is OK, you should see.</p>
<pre>
Password (will be hidden): 
Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run "vault login"
again. Future Vault requests will automatically use this token.

Key                    Value
---                    -----
token                  this-is-not-mikes-token
token_accessor         this-is-not-mikes-token-accessor
token_duration         768h
token_renewable        true
token_policies         ["default"]
identity_policies      []
policies               ["default"]
token_meta_username    mike
</pre>

<h2 id="team-setup">Team Setup</h2>
<h3 id="admin">Admin</h3>
<p>We have a team name and group configured in LDAP. RBAC within OpenShift is configured against this group. We will use this same group name in our vault configuration and setup.</p>
<p>As a <code>cluster-admin</code> we are going to create and configure the team project and vault policies. This sort of on-boarding workflow is pretty common and often automated for OpenShift clusters.</p>
<p>Provision a team namespace.  The $TEAM_GROUP needs to match the LDAP <code>groupdn</code> from above i.e. it is <code>student</code>.</p>
<pre><code class="language-bash">export TEAM_NAME=foo
export TEAM_GROUP=student
export PROJECT_NAME=${TEAM_NAME}-apps
</code></pre>
<pre><code class="language-bash">oc new-project ${PROJECT_NAME}
</code></pre>
<p>Bind our team via the team group so they are project <code>admin</code>'s.</p>
<pre><code class="language-bash">cat &lt;&lt;EOF | oc apply -f-
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: ${TEAM_GROUP}-admin
  namespace: ${PROJECT_NAME}
subjects:
  - kind: Group
    apiGroup: rbac.authorization.k8s.io
    name: ${TEAM_GROUP}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: admin
EOF
</code></pre>
<p>We need to create a k8s service account for the application that our team will deploy. This service account will be used to authenticate to vault using the k8s authentication mechanism. By defult, this is a cluster admin privileged action - otherwise we could have let the user do it.</p>
<pre><code class="language-bash">export APP_NAME=vault-quickstart
</code></pre>
<pre><code class="language-bash">oc -n ${PROJECT_NAME} create sa ${APP_NAME}
oc adm policy add-cluster-role-to-user system:auth-delegator -z ${APP_NAME} -n ${PROJECT_NAME}
</code></pre>
<p>Now we can login to vault and create the ACL policy. There are two parts to the policy. </p>
<p>The first path in our policy uses an <code>ACL template</code>. This allows team users who are part of the $TEAM_GROUP (<code>student</code> in our case) to create <code>key-value</code> data aka <strong>secrets</strong>, under the project specific path. The template is a type of membership check as the user must be part of the <code>student</code> group for them to CRUDL under this <code>kv/</code> path.</p>
<p>The second path in our policy allows CRUDL access for <code>auth/</code> under $BASE_DOMAIN-$PROJECT_NAME. We use this to create k8s <code>config</code> that the application service account may use to authenticate to vault. This is <code>cluster-project</code> specific.</p>
<pre><code class="language-bash">vault login token=${ROOT_TOKEN}
</code></pre>
<pre><code class="language-bash">vault policy write $TEAM_GROUP-$PROJECT_NAME -&lt;&lt;EOF
path &quot;kv/data/{{identity.groups.names.$TEAM_GROUP.name}}/$PROJECT_NAME/*&quot; {
    capabilities = [ &quot;create&quot;, &quot;update&quot;, &quot;read&quot;, &quot;delete&quot;, &quot;list&quot; ]
}
path &quot;auth/$BASE_DOMAIN-$PROJECT_NAME/*&quot; {
    capabilities = [ &quot;create&quot;, &quot;update&quot;, &quot;read&quot;, &quot;delete&quot;, &quot;list&quot; ]
}
EOF
</code></pre>
<p><img alt="images/student-foo-apps-policy.png" src="../images/student-foo-apps-policy.png" /></p>
<p>Next we can create the <code>identity/group</code> in vault that matches our LDAP team group.</p>
<p>We need our list of user ID's to attach to the group. The Web UI makes this easy, but its hard from the CLI. Luckily we only have the one identity entity from our previous <code>mike</code> ldap login.</p>
<pre><code class="language-bash">vault list identity/entity/id
</code></pre>
<pre>
Keys
----
465ea512-80b4-ee7a-4ff2-b992149140b0
</pre>

<p>We need this and our $TEAM_GROUP-$PROJECT_NAME policy to add to our group in vault. The parameters <code>policies</code> and  <code>member_entity_ids</code> are <em>lists</em> so if we have multiple team members and projects we can include them and/or update this when needed.</p>
<pre><code class="language-bash">vault write identity/group name=&quot;$TEAM_GROUP&quot; \
     policies=&quot;$TEAM_GROUP-$PROJECT_NAME&quot; \
     member_entity_ids=465ea512-80b4-ee7a-4ff2-b992149140b0 \
     metadata=team=&quot;$TEAM_GROUP&quot;
</code></pre>
<p>We need to enable k8s based authentication in vault. We create it using a path based on the <code>cluster-project</code> we used in the policy above. Run the following commands.</p>
<pre><code class="language-bash">vault auth enable -path=$BASE_DOMAIN-${PROJECT_NAME} kubernetes
vault auth list
</code></pre>
<p>To allow our application service account to read and list (RL) secrets, we use another ACL template for <code>kv/</code> that uses the k8s auth accessor in the path. The application service account can therefore only RL secrets that match its name and namespace in the path.  </p>
<pre><code class="language-bash">export MOUNT_ACCESSOR=$(vault auth list -format=json | jq -r &quot;.\&quot;$BASE_DOMAIN-$PROJECT_NAME/\&quot;.accessor&quot;)
</code></pre>
<pre><code class="language-bash">vault policy write $BASE_DOMAIN-$PROJECT_NAME-kv-read -&lt;&lt; EOF
    path &quot;kv/data/$TEAM_GROUP/{{identity.entity.aliases.$MOUNT_ACCESSOR.metadata.service_account_namespace}}/{{identity.entity.aliases.$MOUNT_ACCESSOR.metadata.service_account_name}}&quot; {
        capabilities=[&quot;read&quot;,&quot;list&quot;]
    }
EOF
</code></pre>
<pre><code class="language-bash">vault policy read $BASE_DOMAIN-$PROJECT_NAME-kv-read
</code></pre>
<p><img alt="images/acl-policy.png" src="../images/acl-policy.png" /></p>
<p>Lastly, as <code>root</code> we need to enable the KVV2 secrets engine (not to be confused with a V1 kv engine).</p>
<pre><code class="language-bash">vault secrets enable -path=kv/ -version=2 kv
</code></pre>
<p><img alt="images/kvv2-secret-engine.png" src="../images/kvv2-secret-engine.png" /></p>
<h3 id="non-admin">Non-Admin</h3>
<p>We can now create our vault config as our <code>student</code> team user <code>mike</code>.  Login to vault and OpenShift.</p>
<pre><code class="language-bash">oc login --server=https://api.${BASE_DOMAIN}:6443 -u mike
</code></pre>
<pre><code class="language-bash">vault login -method=ldap username=mike
</code></pre>
<p>We should see the policy created by admin above.</p>
<pre>
Key                    Value
---                    -----
token                  this-is-not-mikes-token
token_accessor         this-is-not-mikes-token-accessor
token_duration         768h
token_renewable        true
token_policies         ["default"]
identity_policies      ["student-foo-apps"]
policies               ["default" "student-foo-apps"]
token_meta_username    mike
</pre>

<p>Let's create the $APP_NAME based auth role.</p>
<pre><code class="language-bash">vault write auth/$BASE_DOMAIN-$PROJECT_NAME/role/$APP_NAME \
  bound_service_account_names=$APP_NAME \
  bound_service_account_namespaces=$PROJECT_NAME \
  policies=$BASE_DOMAIN-$PROJECT_NAME-kv-read \
  period=120s
</code></pre>
<p>We need to create the auth config that allows the service account token to be used to do a k8s based login to vault. Lets get the service account token and ca cert.</p>
<pre><code class="language-bash">export SA_TOKEN=$(oc -n ${PROJECT_NAME} get sa/${APP_NAME} -o yaml | grep ${APP_NAME}-token | awk '{print $3}')
export SA_JWT_TOKEN=$(oc -n ${PROJECT_NAME} get secret $SA_TOKEN -o jsonpath=&quot;{.data.token}&quot; | base64 --decode; echo)
export SA_CA_CRT=$(oc -n ${PROJECT_NAME} get secret $SA_TOKEN -o jsonpath=&quot;{.data['ca\.crt']}&quot; | base64 --decode; echo)
</code></pre>
<p>We can create the auth config using these.</p>
<pre><code class="language-bash">vault write auth/$BASE_DOMAIN-${PROJECT_NAME}/config \
  token_reviewer_jwt=&quot;$SA_JWT_TOKEN&quot; \
  kubernetes_host=&quot;$(oc whoami --show-server)&quot; \
  kubernetes_ca_cert=&quot;$SA_CA_CRT&quot;
</code></pre>
<p>We need some KV data for our application to read. Let's create some.</p>
<pre><code class="language-bash">vault kv put kv/$TEAM_GROUP/$PROJECT_NAME/$APP_NAME \
  app=$APP_NAME \
  username=foo \
  password=bar 
</code></pre>
<p>Which we can check.</p>
<pre><code class="language-bash">vault kv get kv/$TEAM_GROUP/$PROJECT_NAME/$APP_NAME
</code></pre>
<pre>
============== Secret Path ==============
kv/data/student/foo-apps/vault-quickstart

======= Metadata =======
Key                Value
---                -----
created_time       2022-05-26T09:56:02.897208905Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
app         vault-quickstart
password    bar
username    foo
</pre>

<p>Time to test out our application.</p>

  <hr>
<div class="md-source-file">
  <small>
    
      Last update:
      2023-08-21
    
  </small>
</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://twitter.com/eformat" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://github.com/eformat" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://instagram.com/eformat" target="_blank" rel="noopener" title="instagram.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.e5c33ebb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.51d95adb.min.js"></script>
      
    
  </body>
</html>